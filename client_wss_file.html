<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WebSocket 文件转写（流式）</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 0 20px;
        }
        #transcriptionResult {
            white-space: pre-wrap;
            background-color: #f5f5f5;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
        }
        .transcript-line {
            margin: 8px 0;
            padding: 8px;
            border-radius: 4px;
            background-color: white;
            border-left: 4px solid #ccc;
        }
        .speaker-label {
            font-weight: bold;
            margin-right: 8px;
            display: inline-block;
            min-width: 80px;
        }
        .speaker-1 { color: #2196F3; border-left-color: #2196F3; }
        .speaker-2 { color: #4CAF50; border-left-color: #4CAF50; }
        .speaker-3 { color: #FF9800; border-left-color: #FF9800; }
        .speaker-4 { color: #9C27B0; border-left-color: #9C27B0; }
        .speaker-5 { color: #F44336; border-left-color: #F44336; }
        .speaker-unknown { color: #757575; border-left-color: #757575; }
        .new-speaker-notification {
            background-color: #E3F2FD;
            color: #1976D2;
            padding: 6px 10px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 0.9em;
            font-style: italic;
        }
        .status-message {
            background-color: #FFF3CD;
            color: #856404;
            padding: 6px 10px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 0.9em;
        }
        .stats-container {
            background-color: #E8F5E9;
            color: #2E7D32;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        .stats-container .stat-item {
            margin: 5px 0;
        }
        .stats-container .stat-label {
            font-weight: bold;
            display: inline-block;
            min-width: 120px;
        }
        #transcribeButton {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
        }
        #transcribeButton.processing {
            background-color: #f44336;
        }
        #transcribeButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .controls {
            margin-bottom: 20px;
        }
        .controls input {
            width: 500px;
            padding: 8px;
            margin-right: 10px;
        }
        .controls label {
            margin-left: 15px;
        }
    </style>
</head>
<body>
    <div>
        <h2>流式音频文件转写</h2>
        <div class="controls">
            <input id="audioUrl" type="text" placeholder="输入音频/视频 URL（支持抖音视频链接）" />
            <button id="transcribeButton">开始转写</button>
            <label>
                语言: 
                <input id="lang" type="text" value="zh" style="width: 80px;" />
            </label>
        </div>
        <hr />
        <h3>识别结果：</h3>
        <div id="transcriptionResult"></div>
    </div>
</body>
<script>
    var transcribeButton = document.getElementById('transcribeButton');
    var transcriptionResult = document.getElementById('transcriptionResult');
    var audioUrlInput = document.getElementById('audioUrl');
    var langInput = document.getElementById('lang');
    var ws = null;
    var isProcessing = false;

    function addStatusMessage(message) {
        var status = document.createElement('div');
        status.className = 'status-message';
        status.textContent = 'ℹ️ ' + message;
        transcriptionResult.appendChild(status);
        transcriptionResult.scrollTop = transcriptionResult.scrollHeight;
    }

    function addTranscriptLine(speaker, text) {
        var line = document.createElement('div');
        line.className = 'transcript-line';
        
        var speakerNum = speaker.replace('speaker_', '');
        if (speakerNum && !isNaN(speakerNum)) {
            line.classList.add('speaker-' + speakerNum);
        } else {
            line.classList.add('speaker-unknown');
        }
        
        var speakerLabel = document.createElement('span');
        speakerLabel.className = 'speaker-label';
        speakerLabel.textContent = '说话人' + (speakerNum || '?') + ':';
        
        var textSpan = document.createElement('span');
        textSpan.textContent = text;
        
        line.appendChild(speakerLabel);
        line.appendChild(textSpan);
        transcriptionResult.appendChild(line);
        
        transcriptionResult.scrollTop = transcriptionResult.scrollHeight;
    }

    function addNewSpeakerNotification(speakerId) {
        var notification = document.createElement('div');
        notification.className = 'new-speaker-notification';
        var speakerNum = speakerId.replace('speaker_', '');
        notification.textContent = '🎤 检测到新说话人：说话人' + speakerNum;
        transcriptionResult.appendChild(notification);
        transcriptionResult.scrollTop = transcriptionResult.scrollHeight;
    }

    function addStatsInfo(stats) {
        var statsDiv = document.createElement('div');
        statsDiv.className = 'stats-container';
        
        var title = document.createElement('div');
        title.style.fontWeight = 'bold';
        title.style.fontSize = '1em';
        title.style.marginBottom = '8px';
        title.textContent = '📊 转写统计信息';
        statsDiv.appendChild(title);
        
        var statItems = [
            { label: '音频时长', value: stats.audio_duration.toFixed(2) + ' 秒' },
            { label: '总耗时', value: stats.total_time.toFixed(2) + ' 秒' },
            { label: '下载耗时', value: stats.download_time.toFixed(2) + ' 秒' },
            { label: '识别耗时', value: stats.recognition_time.toFixed(2) + ' 秒' },
            { label: '识别段数', value: stats.segment_count + ' 段' },
            { label: '处理速度', value: stats.speed_ratio.toFixed(2) + 'x' }
        ];
        
        statItems.forEach(function(item) {
            var statItem = document.createElement('div');
            statItem.className = 'stat-item';
            var label = document.createElement('span');
            label.className = 'stat-label';
            label.textContent = item.label + ':';
            var value = document.createElement('span');
            value.textContent = item.value;
            statItem.appendChild(label);
            statItem.appendChild(value);
            statsDiv.appendChild(statItem);
        });
        
        transcriptionResult.appendChild(statsDiv);
        transcriptionResult.scrollTop = transcriptionResult.scrollHeight;
    }

    transcribeButton.onclick = function() {
        if (!isProcessing) {
            startTranscription();
        } else {
            stopTranscription();
        }
    };

    function startTranscription() {
        var audioUrl = audioUrlInput.value.trim();
        if (!audioUrl) {
            alert('请输入音频/视频 URL');
            return;
        }

        var lang = langInput.value.trim() || 'zh';
        
        // 清空之前的结果
        transcriptionResult.innerHTML = '';
        
        // 连接 WebSocket
        ws = new WebSocket('ws://127.0.0.1:27100/ws/transcribe_file');
        
        ws.onopen = function() {
            console.log('WebSocket 连接已建立');
            addStatusMessage('正在连接服务器...');
            
            // 发送请求数据
            var requestData = {
                audio_url: audioUrl,
                lang: lang
            };
            ws.send(JSON.stringify(requestData));
            console.log('已发送请求:', requestData);
        };

        ws.onmessage = function(event) {
            try {
                var resJson = JSON.parse(event.data);
                console.log('收到消息:', resJson);
                
                // code=10: 开始下载
                if (resJson.code === 10) {
                    addStatusMessage(resJson.msg);
                }
                // code=11: 下载完成
                else if (resJson.code === 11) {
                    addStatusMessage(resJson.msg + ' (时长: ' + resJson.data.duration.toFixed(2) + ' 秒, 下载耗时: ' + resJson.data.download_time.toFixed(2) + ' 秒)');
                }
                // code=4: 检测到新说话人
                else if (resJson.code === 4) {
                    addNewSpeakerNotification(resJson.data);
                }
                // code=0: ASR识别结果
                else if (resJson.code === 0) {
                    var speaker = resJson.speaker || 'unknown';
                    var text = resJson.data || 'No speech recognized';
                    addTranscriptLine(speaker, text);
                }
                // code=12: 处理进度
                else if (resJson.code === 12) {
                    addStatusMessage('处理进度: ' + resJson.data.processed + '/' + resJson.data.total + ' (' + resJson.data.progress.toFixed(1) + '%)');
                }
                // code=100: 转写完成
                else if (resJson.code === 100) {
                    addStatusMessage('✅ ' + resJson.msg);
                    // 显示统计信息
                    if (resJson.data) {
                        addStatsInfo(resJson.data);
                    }
                    stopTranscription();
                }
                // code=-1: 错误
                else if (resJson.code === -1) {
                    addStatusMessage('❌ 错误: ' + resJson.msg);
                    stopTranscription();
                }
            } catch (e) {
                console.error('解析消息失败:', e);
                transcriptionResult.textContent += '\n' + event.data;
            }
        };

        ws.onclose = function() {
            console.log('WebSocket 连接已关闭');
            if (isProcessing) {
                addStatusMessage('连接已断开');
                stopTranscription();
            }
        };

        ws.onerror = function(error) {
            console.error('WebSocket 错误:', error);
            addStatusMessage('❌ 连接错误');
            stopTranscription();
        };

        transcribeButton.textContent = '停止转写';
        transcribeButton.classList.add('processing');
        isProcessing = true;
    }

    function stopTranscription() {
        if (ws) {
            ws.close();
            ws = null;
        }
        transcribeButton.textContent = '开始转写';
        transcribeButton.classList.remove('processing');
        isProcessing = false;
    }
</script>
</html>


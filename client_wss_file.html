<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WebSocket æ–‡ä»¶è½¬å†™ï¼ˆæµå¼ï¼‰</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 0 20px;
        }
        #transcriptionResult {
            white-space: pre-wrap;
            background-color: #f5f5f5;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
        }
        .transcript-line {
            margin: 8px 0;
            padding: 8px;
            border-radius: 4px;
            background-color: white;
            border-left: 4px solid #ccc;
        }
        .speaker-label {
            font-weight: bold;
            margin-right: 8px;
            display: inline-block;
            min-width: 80px;
        }
        .speaker-1 { color: #2196F3; border-left-color: #2196F3; }
        .speaker-2 { color: #4CAF50; border-left-color: #4CAF50; }
        .speaker-3 { color: #FF9800; border-left-color: #FF9800; }
        .speaker-4 { color: #9C27B0; border-left-color: #9C27B0; }
        .speaker-5 { color: #F44336; border-left-color: #F44336; }
        .speaker-unknown { color: #757575; border-left-color: #757575; }
        .new-speaker-notification {
            background-color: #E3F2FD;
            color: #1976D2;
            padding: 6px 10px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 0.9em;
            font-style: italic;
        }
        .status-message {
            background-color: #FFF3CD;
            color: #856404;
            padding: 6px 10px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 0.9em;
        }
        .stats-container {
            background-color: #E8F5E9;
            color: #2E7D32;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        .stats-container .stat-item {
            margin: 5px 0;
        }
        .stats-container .stat-label {
            font-weight: bold;
            display: inline-block;
            min-width: 120px;
        }
        #transcribeButton {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
        }
        #transcribeButton.processing {
            background-color: #f44336;
        }
        #transcribeButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .controls {
            margin-bottom: 20px;
        }
        .controls input {
            width: 500px;
            padding: 8px;
            margin-right: 10px;
        }
        .controls label {
            margin-left: 15px;
        }
    </style>
</head>
<body>
    <div>
        <h2>æµå¼éŸ³é¢‘æ–‡ä»¶è½¬å†™</h2>
        <div class="controls">
            <input id="audioUrl" type="text" placeholder="è¾“å…¥éŸ³é¢‘/è§†é¢‘ URLï¼ˆæ”¯æŒæŠ–éŸ³è§†é¢‘é“¾æ¥ï¼‰" />
            <button id="transcribeButton">å¼€å§‹è½¬å†™</button>
            <label>
                è¯­è¨€: 
                <input id="lang" type="text" value="zh" style="width: 80px;" />
            </label>
        </div>
        <hr />
        <h3>è¯†åˆ«ç»“æœï¼š</h3>
        <div id="transcriptionResult"></div>
    </div>
</body>
<script>
    var transcribeButton = document.getElementById('transcribeButton');
    var transcriptionResult = document.getElementById('transcriptionResult');
    var audioUrlInput = document.getElementById('audioUrl');
    var langInput = document.getElementById('lang');
    var ws = null;
    var isProcessing = false;

    function addStatusMessage(message) {
        var status = document.createElement('div');
        status.className = 'status-message';
        status.textContent = 'â„¹ï¸ ' + message;
        transcriptionResult.appendChild(status);
        transcriptionResult.scrollTop = transcriptionResult.scrollHeight;
    }

    function addTranscriptLine(speaker, text) {
        var line = document.createElement('div');
        line.className = 'transcript-line';
        
        var speakerNum = speaker.replace('speaker_', '');
        if (speakerNum && !isNaN(speakerNum)) {
            line.classList.add('speaker-' + speakerNum);
        } else {
            line.classList.add('speaker-unknown');
        }
        
        var speakerLabel = document.createElement('span');
        speakerLabel.className = 'speaker-label';
        speakerLabel.textContent = 'è¯´è¯äºº' + (speakerNum || '?') + ':';
        
        var textSpan = document.createElement('span');
        textSpan.textContent = text;
        
        line.appendChild(speakerLabel);
        line.appendChild(textSpan);
        transcriptionResult.appendChild(line);
        
        transcriptionResult.scrollTop = transcriptionResult.scrollHeight;
    }

    function addNewSpeakerNotification(speakerId) {
        var notification = document.createElement('div');
        notification.className = 'new-speaker-notification';
        var speakerNum = speakerId.replace('speaker_', '');
        notification.textContent = 'ğŸ¤ æ£€æµ‹åˆ°æ–°è¯´è¯äººï¼šè¯´è¯äºº' + speakerNum;
        transcriptionResult.appendChild(notification);
        transcriptionResult.scrollTop = transcriptionResult.scrollHeight;
    }

    function addStatsInfo(stats) {
        var statsDiv = document.createElement('div');
        statsDiv.className = 'stats-container';
        
        var title = document.createElement('div');
        title.style.fontWeight = 'bold';
        title.style.fontSize = '1em';
        title.style.marginBottom = '8px';
        title.textContent = 'ğŸ“Š è½¬å†™ç»Ÿè®¡ä¿¡æ¯';
        statsDiv.appendChild(title);
        
        var statItems = [
            { label: 'éŸ³é¢‘æ—¶é•¿', value: stats.audio_duration.toFixed(2) + ' ç§’' },
            { label: 'æ€»è€—æ—¶', value: stats.total_time.toFixed(2) + ' ç§’' },
            { label: 'ä¸‹è½½è€—æ—¶', value: stats.download_time.toFixed(2) + ' ç§’' },
            { label: 'è¯†åˆ«è€—æ—¶', value: stats.recognition_time.toFixed(2) + ' ç§’' },
            { label: 'è¯†åˆ«æ®µæ•°', value: stats.segment_count + ' æ®µ' },
            { label: 'å¤„ç†é€Ÿåº¦', value: stats.speed_ratio.toFixed(2) + 'x' }
        ];
        
        statItems.forEach(function(item) {
            var statItem = document.createElement('div');
            statItem.className = 'stat-item';
            var label = document.createElement('span');
            label.className = 'stat-label';
            label.textContent = item.label + ':';
            var value = document.createElement('span');
            value.textContent = item.value;
            statItem.appendChild(label);
            statItem.appendChild(value);
            statsDiv.appendChild(statItem);
        });
        
        transcriptionResult.appendChild(statsDiv);
        transcriptionResult.scrollTop = transcriptionResult.scrollHeight;
    }

    transcribeButton.onclick = function() {
        if (!isProcessing) {
            startTranscription();
        } else {
            stopTranscription();
        }
    };

    function startTranscription() {
        var audioUrl = audioUrlInput.value.trim();
        if (!audioUrl) {
            alert('è¯·è¾“å…¥éŸ³é¢‘/è§†é¢‘ URL');
            return;
        }

        var lang = langInput.value.trim() || 'zh';
        
        // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
        transcriptionResult.innerHTML = '';
        
        // è¿æ¥ WebSocket
        ws = new WebSocket('ws://127.0.0.1:27100/ws/transcribe_file');
        
        ws.onopen = function() {
            console.log('WebSocket è¿æ¥å·²å»ºç«‹');
            addStatusMessage('æ­£åœ¨è¿æ¥æœåŠ¡å™¨...');
            
            // å‘é€è¯·æ±‚æ•°æ®
            var requestData = {
                audio_url: audioUrl,
                lang: lang
            };
            ws.send(JSON.stringify(requestData));
            console.log('å·²å‘é€è¯·æ±‚:', requestData);
        };

        ws.onmessage = function(event) {
            try {
                var resJson = JSON.parse(event.data);
                console.log('æ”¶åˆ°æ¶ˆæ¯:', resJson);
                
                // code=10: å¼€å§‹ä¸‹è½½
                if (resJson.code === 10) {
                    addStatusMessage(resJson.msg);
                }
                // code=11: ä¸‹è½½å®Œæˆ
                else if (resJson.code === 11) {
                    addStatusMessage(resJson.msg + ' (æ—¶é•¿: ' + resJson.data.duration.toFixed(2) + ' ç§’, ä¸‹è½½è€—æ—¶: ' + resJson.data.download_time.toFixed(2) + ' ç§’)');
                }
                // code=4: æ£€æµ‹åˆ°æ–°è¯´è¯äºº
                else if (resJson.code === 4) {
                    addNewSpeakerNotification(resJson.data);
                }
                // code=0: ASRè¯†åˆ«ç»“æœ
                else if (resJson.code === 0) {
                    var speaker = resJson.speaker || 'unknown';
                    var text = resJson.data || 'No speech recognized';
                    addTranscriptLine(speaker, text);
                }
                // code=12: å¤„ç†è¿›åº¦
                else if (resJson.code === 12) {
                    addStatusMessage('å¤„ç†è¿›åº¦: ' + resJson.data.processed + '/' + resJson.data.total + ' (' + resJson.data.progress.toFixed(1) + '%)');
                }
                // code=100: è½¬å†™å®Œæˆ
                else if (resJson.code === 100) {
                    addStatusMessage('âœ… ' + resJson.msg);
                    // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                    if (resJson.data) {
                        addStatsInfo(resJson.data);
                    }
                    stopTranscription();
                }
                // code=-1: é”™è¯¯
                else if (resJson.code === -1) {
                    addStatusMessage('âŒ é”™è¯¯: ' + resJson.msg);
                    stopTranscription();
                }
            } catch (e) {
                console.error('è§£ææ¶ˆæ¯å¤±è´¥:', e);
                transcriptionResult.textContent += '\n' + event.data;
            }
        };

        ws.onclose = function() {
            console.log('WebSocket è¿æ¥å·²å…³é—­');
            if (isProcessing) {
                addStatusMessage('è¿æ¥å·²æ–­å¼€');
                stopTranscription();
            }
        };

        ws.onerror = function(error) {
            console.error('WebSocket é”™è¯¯:', error);
            addStatusMessage('âŒ è¿æ¥é”™è¯¯');
            stopTranscription();
        };

        transcribeButton.textContent = 'åœæ­¢è½¬å†™';
        transcribeButton.classList.add('processing');
        isProcessing = true;
    }

    function stopTranscription() {
        if (ws) {
            ws.close();
            ws = null;
        }
        transcribeButton.textContent = 'å¼€å§‹è½¬å†™';
        transcribeButton.classList.remove('processing');
        isProcessing = false;
    }
</script>
</html>

